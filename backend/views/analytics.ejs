<%- include('partials/header') %>

<main class="container">
  <header class="page-header">
    <div class="header-content">
      <h1>Hospital Analytics & Insights</h1>
      <p style="color: var(--secondary)">
        Real-time performance monitoring and medical device status.
      </p>
    </div>
  </header>

  <div class="analytics-grid">
    <section class="card chart-container">
      <div class="card-header">
        <h2>Monthly Revenue Overview</h2>
      </div>
      <div style="position: relative; height: 350px">
        <canvas id="revenueChart"></canvas>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <h2>Medical Device Status</h2>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Device Name</th>
              <th>Status</th>
              <th>Last Maintenance</th>
              <th>Usage Level</th>
            </tr>
          </thead>
          <tbody>
            <% if (typeof devices !== 'undefined' && devices.length > 0) { %> <%
            devices.forEach(function(device) { %>
            <tr>
              <td><strong><%= device.device_name %></strong></td>
              <td>
                <span
                  class="status-pill <%= device.status === 'Active' ? 'bg-success' : (device.status === 'Maintenance' ? 'bg-warning' : 'bg-danger') %>"
                >
                  <%= device.status %>
                </span>
              </td>
              <td>
                <%= new Date(device.last_checked).toLocaleDateString('en-GB') %>
              </td>
              <td>
                <div style="display: flex; align-items: center; gap: 10px">
                  <progress
                    value="<%= device.usage_percent %>"
                    max="100"
                    style="flex: 1"
                  ></progress>
                  <span><%= device.usage_percent %>%</span>
                </div>
              </td>
            </tr>
            <% }); %> <% } else { %>
            <tr>
              <td
                colspan="4"
                style="
                  text-align: center;
                  padding: 2rem;
                  color: var(--secondary);
                "
              >
                No medical device data available.
              </td>
            </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  async function loadCharts() {
    try {
      const response = await fetch("/analytics/data");
      const data = await response.json();

      if (!data || data.length === 0) {
        console.warn("No chart data received");
        return;
      }

      const ctx = document.getElementById("revenueChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.map((row) => row.month),
          datasets: [
            {
              label: "Revenue ($)",
              data: data.map((row) => row.total_revenue),
              backgroundColor: "#2563eb",
              hoverBackgroundColor: "#1d4ed8",
              borderRadius: 8,
              borderSkipped: false,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: "#1e293b",
              padding: 12,
              titleFont: { size: 14 },
              bodyFont: { size: 14 },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: "#e2e8f0" },
              ticks: { callback: (value) => "$" + value },
            },
            x: {
              grid: { display: false },
            },
          },
        },
      });
    } catch (error) {
      console.error("Error loading chart data:", error);
    }
  }

  // Initialize once DOM is ready
  document.addEventListener("DOMContentLoaded", loadCharts);
</script>

<%- include('partials/footer') %>
